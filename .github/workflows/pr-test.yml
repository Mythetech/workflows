# Reusable workflow for running tests on pull requests
#
# Usage in calling repository:
#
# name: PR Tests
# on:
#   pull_request:
#     branches: [ "main" ]
#
# jobs:
#   test:
#     uses: mythetech/workflows/.github/workflows/pr-test.yml@main
#     with:
#       test_project: "MyApp.Test/MyApp.Test.csproj"

name: PR Test

on:
  workflow_call:
    inputs:
      dotnet_version:
        description: '.NET SDK version to use'
        type: string
        default: '10.0.x'
      test_project:
        description: 'Path to the test project (e.g., MyApp.Test/MyApp.Test.csproj). If not specified, runs "dotnet test" in root.'
        type: string
        required: false
      test_command:
        description: 'Override the test command entirely (e.g., "dotnet test --filter Category=Unit")'
        type: string
        required: false
      enable_coverage:
        description: 'Enable code coverage collection'
        type: boolean
        default: true
      coverage_threshold:
        description: 'Minimum coverage percentage (0-100). Set to 0 to disable threshold check.'
        type: number
        default: 0
      upload_coverage_artifact:
        description: 'Upload coverage results as workflow artifact'
        type: boolean
        default: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install .NET Core
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ inputs.dotnet_version }}

    - name: Execute unit tests
      run: |
        TEST_CMD="${{ inputs.test_command }}"
        TEST_PROJECT="${{ inputs.test_project }}"
        ENABLE_COVERAGE="${{ inputs.enable_coverage }}"

        # Build coverage arguments if enabled
        COVERAGE_ARGS=""
        if [ "$ENABLE_COVERAGE" = "true" ]; then
          # Check for a .runsettings file in any .Test directory
          RUNSETTINGS_FILE=$(find . -name "*.runsettings" -path "*.Test/*" 2>/dev/null | head -1)
          if [ -n "$RUNSETTINGS_FILE" ]; then
            echo "Using runsettings file: $RUNSETTINGS_FILE"
            COVERAGE_ARGS="--settings \"$RUNSETTINGS_FILE\" --collect:\"XPlat Code Coverage\" --results-directory ./TestResults"
          else
            COVERAGE_ARGS='--collect:"XPlat Code Coverage" --results-directory ./TestResults -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura'
          fi
        fi

        if [ -n "$TEST_CMD" ]; then
          if [ "$ENABLE_COVERAGE" = "true" ]; then
            eval "$TEST_CMD $COVERAGE_ARGS"
          else
            eval "$TEST_CMD"
          fi
        elif [ -n "$TEST_PROJECT" ]; then
          eval "dotnet test \"$TEST_PROJECT\" --configuration Release $COVERAGE_ARGS"
        else
          eval "dotnet test --configuration Release $COVERAGE_ARGS"
        fi
      shell: bash
      env:
        Configuration: Release

    - name: Generate coverage report
      if: inputs.enable_coverage && always()
      run: |
        dotnet tool install -g dotnet-reportgenerator-globaltool || true

        COVERAGE_FILE=$(find ./TestResults -name "coverage.cobertura.xml" 2>/dev/null | head -1)

        if [ -n "$COVERAGE_FILE" ]; then
          echo "Found coverage file: $COVERAGE_FILE"

          reportgenerator \
            -reports:"$COVERAGE_FILE" \
            -targetdir:./TestResults/CoverageReport \
            -reporttypes:"MarkdownSummaryGithub;Html"

          if [ -f "./TestResults/CoverageReport/SummaryGithub.md" ]; then
            cat ./TestResults/CoverageReport/SummaryGithub.md >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "::warning::No coverage file found"
        fi
      shell: bash

    - name: Check coverage threshold
      if: inputs.enable_coverage && inputs.coverage_threshold > 0
      run: |
        THRESHOLD=${{ inputs.coverage_threshold }}
        COVERAGE_FILE=$(find ./TestResults -name "coverage.cobertura.xml" 2>/dev/null | head -1)

        if [ -n "$COVERAGE_FILE" ]; then
          LINE_COVERAGE=$(grep -oP 'line-rate="\K[^"]+' "$COVERAGE_FILE" | head -1)
          COVERAGE_PCT=$(echo "scale=2; $LINE_COVERAGE * 100" | bc)

          echo "Coverage: ${COVERAGE_PCT}%, Threshold: ${THRESHOLD}%"

          if (( $(echo "$COVERAGE_PCT < $THRESHOLD" | bc -l) )); then
            echo "::error::Coverage ${COVERAGE_PCT}% is below threshold ${THRESHOLD}%"
            exit 1
          else
            echo "::notice::Coverage ${COVERAGE_PCT}% meets threshold ${THRESHOLD}%"
          fi
        else
          echo "::warning::No coverage file found, skipping threshold check"
        fi
      shell: bash

    - name: Upload coverage artifact
      if: inputs.enable_coverage && inputs.upload_coverage_artifact && always()
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: |
          ./TestResults/**/coverage.cobertura.xml
          ./TestResults/CoverageReport/
        retention-days: 14
